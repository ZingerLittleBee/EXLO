---
title: 故障排除
description: 常见问题及解决方案。
icon: BadgeAlert
---

## SSH 连接问题

### Host Key 验证失败

**现象**：
```
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
```

**原因**：服务器重新部署后 Host Key 变更。

**解决方案**：
```bash
# 移除旧的 Host Key
ssh-keygen -R "[tunnel.example.com]:2222"

# 重新连接
ssh -N -R 8000:localhost:8000 -p 2222 user@tunnel.example.com
```

### 连接超时

**现象**：
```
ssh: connect to host tunnel.example.com port 2222: Connection timed out
```

**排查步骤**：

1. 检查端口是否开放：
   ```bash
   nc -zv tunnel.example.com 2222
   ```

2. 检查防火墙规则：
   ```bash
   # 云服务器安全组需放行 2222 端口
   ```

3. 检查服务是否运行：
   ```bash
   docker compose ps
   docker compose logs tunnel
   ```

### Permission Denied

**现象**：
```
Permission denied (publickey).
```

**原因**：Device Flow 认证未完成或超时。

**解决方案**：
- 确保按提示完成浏览器认证
- 认证有效期为 5 分钟，超时需重新连接

### 端口不一致问题

**重要提示**：由于 SSH 协议的限制，服务端**无法**获取你实际的本地端口号。因此当远程端口和本地端口不一致时，连接**不会**立即断开，但隧道将无法正常工作。

**现象**：隧道连接成功，但访问时无法正确路由到本地服务。

**原因**：`-R` 参数中的远程端口和本地端口不一致。服务端只能看到远程端口，无法得知实际的本地端口。

**解决方案**：**务必**确保远程端口和本地端口相同：

```bash
# ❌ 错误 - 端口不匹配（连接不会断开，但隧道无法正常工作）
ssh -R 8080:localhost:8000 -p 2222 user@your.domain

# ✅ 正确 - 端口一致
ssh -R 8000:localhost:8000 -p 2222 user@your.domain
```

> [!IMPORTANT]
> 两个端口必须相同，隧道才能正常工作。请始终保持 `-R` 参数中的远程端口与本地服务端口一致。

---

## Device Flow 认证问题

### 验证码无效

**现象**：浏览器提示 "Code not found" 或 "Code expired"。

**原因**：
- 验证码输入错误
- 认证请求已超时（5 分钟）

**解决方案**：
```bash
# 断开当前连接，重新建立
# 按 Enter 然后输入 ~.
# 重新连接获取新验证码
ssh -N -R 8000:localhost:8000 -p 2222 user@tunnel.example.com
```

### 无法访问认证页面

**现象**：浏览器无法打开 `https://tunnel.example.com/activate`。

**排查步骤**：

1. 检查 Web 服务是否运行：
   ```bash
   docker compose logs web
   ```

2. 检查反向代理配置：
   ```bash
   # Nginx
   nginx -t

   # Caddy
   caddy validate
   ```

---

## 隧道无法访问

### 子域名解析失败

**现象**：
```
curl: (6) Could not resolve host: abc123.tunnel.example.com
```

**原因**：DNS 未配置通配符记录。

**解决方案**：
```
# 添加 DNS 记录
*.tunnel.example.com  A  <服务器 IP>
```

### 502 Bad Gateway

**现象**：访问隧道 URL 返回 502 错误。

**可能原因**：

1. **本地服务未运行**
   ```bash
   # 确保本地服务在运行
   curl localhost:3000
   ```

2. **SSH 隧道已断开**
   ```bash
   # 检查 SSH 连接是否存活
   # 重新建立连接
   ssh -R 8000:localhost:8000 -p 2222 user@tunnel.example.com
   ```

3. **HTTP Proxy 服务异常**
   ```bash
   docker compose logs tunnel | grep -i error
   ```

---

## 断开 SSH 连接

### 双击 ESC（推荐）

在隧道终端中快速双击 `ESC` 键即可断开连接。

> [!TIP]
> 第一次按 ESC 会显示提示信息，2 秒内再次按 ESC 确认断开。

### 使用 Ctrl+C

SSH 反向隧道模式下，`Ctrl+C` 通常可以终止连接。

### 使用转义序列

```
1. 按 Enter（确保在新行开头）
2. 输入 ~.（波浪号 + 点）
```

> [!TIP]
> 如果使用嵌套 SSH（先 SSH 到跳板机，再 SSH 到 EXLO），需要连按两次 `~`：`~~.`

### 从 Web Dashboard 终止

1. 登录 Web Dashboard
2. 导航到隧道列表
3. 点击对应隧道的 "断开" 按钮

---

## 断线重连问题

### 重连后需要重新认证

**现象**：断线重连后，仍然需要完成 Device Flow 认证。

**可能原因**：

1. **超过 30 分钟**：认证缓存有效期为 30 分钟
2. **更换了设备/SSH 密钥**：重连识别基于 SSH 公钥指纹

**解决方案**：
- 如果经常需要重连，建议使用 `autossh` 保持连接
- 确保使用相同的 SSH 密钥

### 重连后子域名变了

**现象**：断线重连后，分配了新的子域名。

**可能原因**：
- 认证缓存已过期（超过 30 分钟）
- 使用了不同的 SSH 密钥

**解决方案**：
- 使用 `autossh` 保持长连接，避免断线
- 30 分钟内重连可保持相同子域名

### autossh 无法自动重连

**现象**：使用 autossh 后，断线不会自动重连。

**排查步骤**：

1. 确保使用正确的参数：
   ```bash
   autossh -M 0 \
     -o "ServerAliveInterval=30" \
     -o "ServerAliveCountMax=3" \
     -o "ExitOnForwardFailure=yes" \
     -R 80:localhost:3000 -p 2222 user@your.domain
   ```

2. 检查 autossh 日志：
   ```bash
   export AUTOSSH_DEBUG=1
   autossh -M 0 ...
   ```

3. 确保本地服务正在运行（`ExitOnForwardFailure=yes` 会在转发失败时退出）

---

## 日志查看

```bash
# 查看所有日志
docker compose logs -f

# 仅查看 SSH 服务日志
docker compose logs -f tunnel

# 查看 Web 服务日志
docker compose logs -f web

# 过滤错误日志
docker compose logs tunnel 2>&1 | grep -i error
```

