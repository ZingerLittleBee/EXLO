# syntax=docker/dockerfile:1

# ---- Builder Stage ----
FROM oven/bun:1.3-alpine AS builder
WORKDIR /app

# Copy all source code
COPY package.json bun.lock bunfig.toml turbo.json biome.json ./
COPY apps/web ./apps/web
COPY packages ./packages

# Install all dependencies (including devDependencies for build)
RUN bun install

# Build the application
WORKDIR /app/apps/web
RUN bun --bun run build

# Prune dev dependencies after build
WORKDIR /app
RUN rm -rf node_modules/.cache && \
    rm -rf node_modules/@types && \
    rm -rf node_modules/typescript && \
    rm -rf node_modules/@biomejs && \
    rm -rf node_modules/turbo && \
    rm -rf node_modules/ultracite && \
    rm -rf node_modules/@vitejs && \
    rm -rf node_modules/vite && \
    rm -rf node_modules/@tailwindcss && \
    rm -rf node_modules/tailwindcss && \
    rm -rf node_modules/@tanstack/react-router-devtools && \
    rm -rf node_modules/@tanstack/react-query-devtools && \
    rm -rf node_modules/@testing-library && \
    rm -rf node_modules/jsdom && \
    rm -rf node_modules/esbuild && \
    rm -rf node_modules/rollup && \
    find node_modules -name "*.d.ts" -delete && \
    find node_modules -name "*.map" -delete && \
    find node_modules -name "*.md" -delete && \
    find node_modules -name "LICENSE*" -delete && \
    find node_modules -name "*.ts" ! -name "*.d.ts" -delete 2>/dev/null || true

# ---- Production Stage ----
FROM oven/bun:1.3-alpine AS production
WORKDIR /app
ENV NODE_ENV=production

# Copy pruned node_modules
COPY --from=builder /app/node_modules ./node_modules

# Copy the built application
COPY --from=builder /app/apps/web/dist ./dist

# Copy db package for migrations (source needed for drizzle-kit)
COPY --from=builder /app/packages/db ./packages/db

# Copy package.json files for workspace resolution
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/apps/web/package.json ./apps/web/package.json

# Create entrypoint script
RUN echo '#!/bin/sh' > /app/entrypoint.sh && \
    echo 'set -e' >> /app/entrypoint.sh && \
    echo 'echo "Running database migrations..."' >> /app/entrypoint.sh && \
    echo 'cd /app/packages/db' >> /app/entrypoint.sh && \
    echo 'bunx drizzle-kit migrate' >> /app/entrypoint.sh && \
    echo 'echo "Starting application..."' >> /app/entrypoint.sh && \
    echo 'cd /app' >> /app/entrypoint.sh && \
    echo 'exec bun run dist/server/server.js' >> /app/entrypoint.sh && \
    chmod +x /app/entrypoint.sh

EXPOSE 3000

ENTRYPOINT ["/app/entrypoint.sh"]
