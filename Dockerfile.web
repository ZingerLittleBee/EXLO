# syntax=docker/dockerfile:1

# ---- Builder Stage ----
FROM oven/bun:1.3-alpine AS builder
WORKDIR /app

# Copy all source code
COPY package.json bun.lock bunfig.toml turbo.json biome.json ./
COPY apps/web ./apps/web
COPY packages ./packages

# Install all dependencies (including devDependencies for build)
RUN bun install

# Build the application
WORKDIR /app/apps/web
RUN bun --bun run build

# ---- Deps Stage: Install only runtime dependencies ----
FROM oven/bun:1.3-alpine AS deps
WORKDIR /app

# Copy runtime dependencies config
COPY docker/web.runtime.json ./package.json

# Install only these dependencies
RUN bun install --production

# Clean up
RUN rm -rf node_modules/.cache \
           node_modules/@types \
    && find node_modules -name "*.d.ts" -delete \
    && find node_modules -name "*.map" -delete \
    && find node_modules -name "*.md" ! -name "README.md" -delete \
    && find node_modules -name "LICENSE*" -delete

# ---- Production Stage ----
FROM oven/bun:1.3-alpine AS production
WORKDIR /app
ENV NODE_ENV=production

# Copy production node_modules from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy the built application
COPY --from=builder /app/apps/web/dist ./dist

EXPOSE 3000

CMD ["bun", "run", "dist/server/server.js"]
