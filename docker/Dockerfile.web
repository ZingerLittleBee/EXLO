# syntax=docker/dockerfile:1

# ---- Builder Stage ----
FROM oven/bun:1.3-alpine AS builder
WORKDIR /app

# Copy all source code
COPY package.json bun.lock bunfig.toml turbo.json biome.json ./
COPY apps/web ./apps/web
COPY packages ./packages

# Install all dependencies (including devDependencies for build)
RUN bun install

# Build the application
WORKDIR /app/apps/web
RUN bun --bun run build

# ---- Production Stage ----
FROM oven/bun:1.3-alpine AS production
WORKDIR /app
ENV NODE_ENV=production

# Copy built output from builder stage
COPY --from=builder /app/apps/web/.output ./output

EXPOSE 3000

CMD ["bun", "run", "output/server/index.mjs"]
